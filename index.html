<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی سه لیوان</title>
    <style>
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-Variable-font-face.css') format('css');
            font-weight: 100 900;
            font-style: normal;
        }

        body {
            background-color: #f0f0f0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Vazirmatn', sans-serif;
            color: #333;
            overflow: hidden;
            flex-direction: column;
            position: relative;
        }

        .game-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            max-width: 90vw;
            max-height: 90vh;
        }

        #gameCanvas {
            border-radius: 15px;
            cursor: pointer;
            touch-action: none; /* جلوگیری از اسکرول روی موبایل */
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }

        .ui-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .score-panel {
            display: flex;
            gap: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .difficulty-panel {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }
        
        .difficulty-panel select {
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f9f9f9;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            border: none;
            border-radius: 12px;
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
            box-shadow: 5px 5px 10px #bebebe, -5px -5px 10px #ffffff;
            transition: all 0.2s ease;
            color: #555;
        }

        .btn:hover {
            box-shadow: 2px 2px 5px #bebebe, -2px -2px 5px #ffffff;
            transform: translateY(1px);
        }

        .btn:active {
            box-shadow: inset 2px 2px 5px #bebebe, inset -2px -2px 5px #ffffff;
            transform: translateY(2px);
        }

        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            animation: fadeIn 0.3s ease-out;
            pointer-events: none;
            opacity: 0;
            z-index: 10;
        }
        
        .message-box.visible {
            opacity: 1;
            pointer-events: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

    </style>
</head>
<body>
    <div class="game-container">
        <div class="ui-panel">
            <div class="score-panel">
                <span id="winCount">برد: ۰</span>
                <span id="lossCount">باخت: ۰</span>
            </div>
            <div class="difficulty-panel">
                <span>سطح:</span>
                <select id="difficulty">
                    <option value="easy">آسان</option>
                    <option value="medium" selected>متوسط</option>
                    <option value="hard">سخت</option>
                </select>
            </div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div class="controls">
            <button id="startButton" class="btn">شروع</button>
        </div>
        <div id="messageBox" class="message-box"></div>
    </div>

    <script>
        // تعریف متغیرهای قابل تنظیم
        const config = {
            canvasWidth: 800,
            canvasHeight: 500,
            cupColor: '#d6d6d6',
            cupShadowColor: 'rgba(0, 0, 0, 0.1)',
            ballColor: '#e74c3c',
            cupWidthRatio: 0.15, // عرض لیوان نسبت به عرض کانواس
            cupHeightRatio: 0.3, // ارتفاع لیوان نسبت به ارتفاع کانواس
            cupSpacingRatio: 0.3, // فاصله بین لیوان‌ها نسبت به عرض کانواس
            cupAnimationDuration: 400, // میلی‌ثانیه
            shuffleAnimationDuration: 600, // میلی‌ثانیه برای هر جابه‌جایی
            revealDuration: 1000 // مدت زمان نمایش توپ در ابتدا
        };

        const difficulties = {
            easy: { shuffles: 5, speed: 1.0 },
            medium: { shuffles: 10, speed: 1.2 },
            hard: { shuffles: 15, speed: 1.5 }
        };

        // المان‌های DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const difficultySelect = document.getElementById('difficulty');
        const winCountSpan = document.getElementById('winCount');
        const lossCountSpan = document.getElementById('lossCount');
        const messageBox = document.getElementById('messageBox');
        
        // وضعیت بازی
        let gameState = 'idle'; // 'idle', 'showing', 'shuffling', 'awaitingChoice', 'revealing', 'gameover'
        let cups = [];
        let ballPosition = -1;
        let shuffleAnimation = null;
        let score = { wins: 0, losses: 0 };
        let currentDifficulty = difficulties.medium;
        let shuffleCount = 0;
        let totalShuffles;
        let gameActive = false;

        // تابع برای تنظیم اندازه کانواس
        function resizeCanvas() {
            const container = document.querySelector('.game-container');
            const aspectRatio = config.canvasWidth / config.canvasHeight;
            let newWidth = container.clientWidth - 40;
            let newHeight = newWidth / aspectRatio;

            if (newHeight > container.clientHeight - 100) {
                newHeight = container.clientHeight - 100;
                newWidth = newHeight * aspectRatio;
            }

            canvas.width = newWidth;
            canvas.height = newHeight;

            // به‌روزرسانی ابعاد و موقعیت لیوان‌ها
            setupCups();
            draw();
        }

        // تابع برای راه‌اندازی اولیه لیوان‌ها
        function setupCups() {
            const cupWidth = canvas.width * config.cupWidthRatio;
            const cupHeight = canvas.height * config.cupHeightRatio;
            const cupSpacing = canvas.width * config.cupSpacingRatio;

            // موقعیت اولیه لیوان‌ها را محاسبه می‌کنیم
            const startX = (canvas.width - (cupWidth * 3 + cupSpacing * 2)) / 2;

            cups = [
                { id: 0, x: startX, y: canvas.height - cupHeight - 20, width: cupWidth, height: cupHeight, isUp: false },
                { id: 1, x: startX + cupWidth + cupSpacing, y: canvas.height - cupHeight - 20, width: cupWidth, height: cupHeight, isUp: false },
                { id: 2, x: startX + (cupWidth + cupSpacing) * 2, y: canvas.height - cupHeight - 20, width: cupWidth, height: cupHeight, isUp: false }
            ];
        }

        // تابع برای رسم لیوان‌ها و توپ
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // اول توپ را رسم می‌کنیم تا زیر لیوان‌ها باشد
            if (ballPosition !== -1) {
                const ballCup = cups[ballPosition];
                const ballRadius = ballCup.width * 0.2;
                const ballX = ballCup.x + ballCup.width / 2;
                const ballY = ballCup.y + ballCup.height - ballRadius - 5;
                
                // انیمیشن کوچک bounce برای توپ
                let bounceY = 0;
                if (gameState === 'revealing' || gameState === 'showing') {
                     const time = Date.now() / 100;
                     bounceY = Math.sin(time) * 3;
                }

                ctx.beginPath();
                ctx.arc(ballX, ballY + bounceY, ballRadius, 0, Math.PI * 2);
                ctx.fillStyle = config.ballColor;
                ctx.fill();
                ctx.closePath();
            }

            // سپس لیوان‌ها را رسم می‌کنیم
            cups.forEach(cup => {
                const topY = cup.y;
                const bottomY = cup.y + cup.height;
                const topWidth = cup.width * 0.75;
                
                // سایه ساده
                ctx.beginPath();
                ctx.ellipse(cup.x + cup.width / 2, cup.y + cup.height + 5, cup.width / 2 * 0.8, 5, 0, 0, Math.PI * 2);
                ctx.fillStyle = cup.isUp ? 'transparent' : config.cupShadowColor;
                ctx.fill();

                // بدنه لیوان
                ctx.beginPath();
                ctx.moveTo(cup.x, bottomY);
                ctx.lineTo(cup.x + (cup.width - topWidth) / 2, topY);
                ctx.lineTo(cup.x + (cup.width - topWidth) / 2 + topWidth, topY);
                ctx.lineTo(cup.x + cup.width, bottomY);
                ctx.closePath();
                ctx.fillStyle = config.cupColor;
                ctx.fill();
                ctx.strokeStyle = '#bdbdbd';
                ctx.lineWidth = 2;
                ctx.stroke();

                // لبه لیوان
                ctx.beginPath();
                ctx.ellipse(cup.x + cup.width / 2, topY, topWidth / 2, topWidth * 0.1, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#e0e0e0';
                ctx.fill();
                ctx.strokeStyle = '#999';
                ctx.lineWidth = 1;
                ctx.stroke();
            });
        }

        // تابع برای جابه‌جایی دو لیوان
        function swapCups(cup1Index, cup2Index) {
            return new Promise(resolve => {
                const cup1 = cups[cup1Index];
                const cup2 = cups[cup2Index];
                const startX1 = cup1.x;
                const startX2 = cup2.x;
                const distance = Math.abs(startX1 - startX2);
                
                const duration = config.shuffleAnimationDuration / currentDifficulty.speed;
                let startTime = null;

                function animateSwap(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const elapsed = timestamp - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // از تابع easing برای حرکت نرم استفاده می‌کنیم
                    const easedProgress = 0.5 - 0.5 * Math.cos(progress * Math.PI);

                    cup1.x = startX1 + (startX2 - startX1) * easedProgress;
                    cup2.x = startX2 + (startX1 - startX2) * easedProgress;

                    // انیمیشن کوچک لرزش در پایان
                    if (progress >= 1) {
                        // لرزش نهایی
                        const jiggleAmplitude = 3;
                        const jiggleFrequency = 200; // میلی‌ثانیه
                        const jiggleTime = (timestamp - (startTime + duration)) / jiggleFrequency;
                        if (jiggleTime < 1) {
                            cup1.x += Math.sin(jiggleTime * Math.PI * 2) * jiggleAmplitude * (1-jiggleTime);
                            cup2.x += Math.sin(jiggleTime * Math.PI * 2) * jiggleAmplitude * (1-jiggleTime);
                        } else {
                            // در پایان لرزش، موقعیت‌ها را ثابت می‌کنیم
                            [cup1.x, cup2.x] = [startX2, startX1];
                            // به‌روزرسانی آرایه لیوان‌ها
                            const tempCup = cups[cup1Index];
                            cups[cup1Index] = cups[cup2Index];
                            cups[cup2Index] = tempCup;
                            // بررسی می‌کنیم آیا توپ جابه‌جا شده است
                            if (ballPosition === cup1Index) {
                                ballPosition = cup2Index;
                            } else if (ballPosition === cup2Index) {
                                ballPosition = cup1Index;
                            }
                            draw();
                            return resolve();
                        }
                    }

                    draw();
                    shuffleAnimation = requestAnimationFrame(animateSwap);
                }
                shuffleAnimation = requestAnimationFrame(animateSwap);
            });
        }

        // تابع برای شروع جابه‌جایی
        async function startShuffling() {
            gameState = 'shuffling';
            shuffleCount = 0;
            totalShuffles = Math.floor(Math.random() * currentDifficulty.shuffles) + currentDifficulty.shuffles;
            await shuffleLoop();
            
            gameState = 'awaitingChoice';
            showMessage('حدس بزن توپ زیر کدام لیوان است؟', 3000);
        }

        // حلقه جابه‌جایی
        async function shuffleLoop() {
            if (shuffleCount >= totalShuffles) {
                return;
            }
            
            // انتخاب دو لیوان تصادفی و مطمئن شدن از اینکه تکراری نباشند
            let cup1Index = Math.floor(Math.random() * 3);
            let cup2Index;
            do {
                cup2Index = Math.floor(Math.random() * 3);
            } while (cup1Index === cup2Index);

            await swapCups(cup1Index, cup2Index);
            shuffleCount++;
            await new Promise(resolve => setTimeout(resolve, 100)); // تأخیر کوتاه بین هر جابه‌جایی
            
            // فراخوانی مجدد برای ادامه
            await shuffleLoop();
        }

        // تابع برای بلند کردن لیوان
        function revealCup(cupIndex) {
            return new Promise(resolve => {
                gameState = 'revealing';
                const cup = cups[cupIndex];
                const startY = cup.y;
                const endY = cup.y - cup.height / 1.5;
                const duration = config.cupAnimationDuration;
                let startTime = null;

                function animateReveal(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const elapsed = timestamp - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easedProgress = 1 - Math.pow(1 - progress, 3); // easing out

                    cup.y = startY + (endY - startY) * easedProgress;
                    cup.isUp = easedProgress > 0.5;

                    draw();
                    if (progress < 1) {
                        requestAnimationFrame(animateReveal);
                    } else {
                        resolve();
                    }
                }
                requestAnimationFrame(animateReveal);
            });
        }
        
        // تابع برای بازیابی لیوان بلند شده
        function lowerCup(cupIndex) {
            return new Promise(resolve => {
                const cup = cups[cupIndex];
                const startY = cup.y;
                const endY = canvas.height - cup.height - 20;
                const duration = config.cupAnimationDuration;
                let startTime = null;
                
                function animateLower(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const elapsed = timestamp - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easedProgress = Math.pow(progress, 3); // easing in

                    cup.y = startY + (endY - startY) * easedProgress;
                    cup.isUp = easedProgress > 0.5;

                    draw();
                    if (progress < 1) {
                        requestAnimationFrame(animateLower);
                    } else {
                        cup.isUp = false;
                        resolve();
                    }
                }
                requestAnimationFrame(animateLower);
            });
        }


        // تابع اصلی برای شروع بازی
        function initGame() {
            // مخفی کردن دکمه شروع و نمایش کنترل‌ها
            startButton.style.display = 'none';
            difficultySelect.disabled = false;
            gameActive = true;
            
            // انتخاب تصادفی موقعیت توپ
            ballPosition = Math.floor(Math.random() * 3);
            
            // نمایش اولیه توپ
            gameState = 'showing';
            showMessage('توپ اینجاست!', config.revealDuration);
            draw();
            
            // انیمیشن بلند کردن و پایین آوردن لیوان
            const cupToReveal = cups[ballPosition];
            revealCup(cupToReveal.id)
                .then(() => new Promise(resolve => setTimeout(resolve, config.revealDuration)))
                .then(() => lowerCup(cupToReveal.id))
                .then(() => new Promise(resolve => setTimeout(resolve, 500))) // تأخیر قبل از شروع جابه‌جایی
                .then(() => {
                    startShuffling();
                });
        }
        
        // هندلر کلیک/لمس روی کانواس
        function handleCanvasClick(event) {
            if (gameState !== 'awaitingChoice') {
                return;
            }

            const rect = canvas.getBoundingClientRect();
            let x, y;
            if (event.type === 'touchstart') {
                event.preventDefault(); // جلوگیری از اسکرول
                const touch = event.touches[0];
                x = touch.clientX - rect.left;
                y = touch.clientY - rect.top;
            } else {
                x = event.clientX - rect.left;
                y = event.clientY - rect.top;
            }

            const chosenCup = cups.find(cup => {
                // منطق تشخیص کلیک روی لیوان
                return x > cup.x && x < cup.x + cup.width && y > cup.y && y < cup.y + cup.height;
            });

            if (chosenCup) {
                gameState = 'revealing';
                revealCup(chosenCup.id).then(() => {
                    if (chosenCup.id === ballPosition) {
                        score.wins++;
                        showMessage('برنده شدی!', 2000);
                    } else {
                        score.losses++;
                        showMessage('باختی!', 2000);
                        // نمایش لیوان درست هم بعد از باخت
                        revealCup(ballPosition);
                    }
                    updateScore();
                    saveGame();
                    setTimeout(endGame, 3000);
                });
            }
        }
        
        // تابع پایان بازی
        function endGame() {
            gameState = 'gameover';
            startButton.innerText = 'بازی دوباره';
            startButton.style.display = 'block';
            difficultySelect.disabled = false;

            // پایین آوردن همه لیوان‌ها
            cups.forEach(cup => {
                if (cup.isUp) lowerCup(cup.id);
            });
        }

        // تابع برای نمایش پیام
        function showMessage(text, duration) {
            messageBox.innerText = text;
            messageBox.classList.add('visible');
            if (duration) {
                setTimeout(() => {
                    message